apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  labels:
    datacenter: dc0
  name: amq-dc0
spec:
  acceptors:
  - name: tls-mqtt
    enabledProtocols: TLSv1.2
    expose: true
    port: 8883
    protocols: mqtt
    sslEnabled: true
    sslProvider: JDK
    # Secret is mounted on /etc/<secret-name>/
    sslSecret: tls-mqtt-secret
  - name: plain-amqp
    port: 5672
    protocols: amqp
  - name: tls-amqp
    enabledProtocols: TLSv1.2
    expose: false
    port: 5673
    protocols: amqp
    sslEnabled: true
    sslProvider: JDK
    # Secret is mounted on /etc/<secret-name>/
    sslSecret: tls-amqp-secret

  addressSettings:
    addressSetting:
    - match: '#'
      autoCreateQueues: true
      autoCreateAddresses: true
      autoDeleteQueues: true
      autoDeleteAddress: true
      maxSizeBytes: 100Mb
    - match: DLQ
      maxSizeBytes: 20Mb
    - match: ExpiryQueue
      maxSizeBytes: 20Mb
# SEE: https://github.com/apache/activemq-artemis/blob/47bcf5b73c69e3fa0f681a13801af87b534157f4/artemis-server/src/test/java/org/apache/activemq/artemis/core/config/impl/ConfigurationImplTest.java#L714
# Mirror events are always stored on a local queue prefixed as "$ACTIVEMQARTEMIS_MIRROR" and then concatenated with the broker connection's configured name
# In this case: $ACTIVEMQ_ARTEMIS_MIRROR_dc2
  brokerProperties:
#  - "clusterConfiguration.dc0-cluster-config.name=dc0-cluster-config"
  - "clusterConfigurations.my-cluster.messageLoadBalancingType=OFF_WITH_REDISTRIBUTION"
  console:
    expose: true
    sslEnabled: true
    sslSecret: tls-console-secret
  deploymentPlan:
    clustered: true
    extraMounts:
      secrets:
      - remote-cluster-truststore
      - mirror-configuration
    image: placeholder
    initImage: >-
      quay.io/ryanezil/amq-mirroring/amq-broker-init-rhel8-customized:0.0.0-ocp-7.10-38
    livenessProbe:
      initialDelaySeconds: 240
      timeoutSeconds: 30
    enableMetricsPlugin: true
    messageMigration: true
    persistenceEnabled: true
    podSecurity: {}
    readinessProbe:
      timeoutSeconds: 30
    requireLogin: true
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 200m
        memory: 128Mi
    size: 2
    storage:
      size: 1Gi
  upgrades:
    enabled: true
    minor: true
  version: 7.10.2
